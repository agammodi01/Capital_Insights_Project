import pandas as pd
import yfinance as yf
import pyodbc
from datetime import datetime, timedelta

# ===============================
# 1Ô∏è‚É£ READ MASTER CSV
# ===============================
master = pd.read_csv("C:\\Users\\Lenovo\\OneDrive\\Desktop\\Capital Insights Project\\Data\\stock_master_full.csv")
yf_symbols = master["YF_SYMBOL"].dropna().tolist()

# ===============================
# 2Ô∏è‚É£ SQL CONNECTION
# ===============================
conn = pyodbc.connect(
    r"DRIVER={ODBC Driver 17 for SQL Server};"
    r"SERVER=DESKTOP-OPFLA61\SQLEXPRESS;"
    r"DATABASE=StockMarket;"
    r"Trusted_Connection=yes;"
)
cursor = conn.cursor()

# (Speed improvement ‚Äì optional but safe)
cursor.fast_executemany = True

# ===============================
# 3Ô∏è‚É£ INSERT QUERY
# ===============================
insert_sql = """
INSERT INTO StockPriceDaily
(TradeDate, Symbol, OpenPrice, HighPrice, LowPrice, ClosePrice, AdjClose, Volume)
VALUES (?,?,?,?,?,?,?,?)
"""

# ===============================
# 4Ô∏è‚É£ GET MAX TRADE DATE
# ===============================
def get_max_trade_date(symbol):
    cursor.execute(
        "SELECT MAX(TradeDate) FROM StockPriceDaily WHERE Symbol = ?",
        symbol
    )
    return cursor.fetchone()[0]

today = datetime.today().date()

# ===============================
# 5Ô∏è‚É£ MAIN LOOP
# ===============================
for yf_sym in yf_symbols:
    symbol = yf_sym.replace(".NS", "")
    print(f"\nProcessing: {symbol}")

    # ---- Get last date from SQL
    try:
        max_date = get_max_trade_date(symbol)
    except Exception as e:
        print("‚ùå Max date fetch error:", symbol, e)
        continue

    # ---- Decide start date
    if max_date:
        start_date = max_date + timedelta(days=1)
    else:
        start_date = today - timedelta(days=1825)  # fallback: 5 years

    if start_date > today:
        print("‚úî Already up to date")
        continue

    print(f"Fetching from {start_date} to {today}")

    # ---- Fetch from Yahoo
    data = yf.download(
        yf_sym,
        start=start_date.strftime("%Y-%m-%d"),
        end=(today + timedelta(days=1)).strftime("%Y-%m-%d"),
        auto_adjust=False,
        progress=True
    )

    if data.empty:
        print("‚ö† No Yahoo data")
        continue

    # ---- Reset index
    data.reset_index(inplace=True)

    # ---- FIX: Flatten MultiIndex columns (VERY IMPORTANT)
    if isinstance(data.columns, pd.MultiIndex):
        data.columns = data.columns.get_level_values(0)

    # ---- Ensure Date column is datetime
    data["Date"] = pd.to_datetime(data["Date"])

    inserted = 0

    # ===============================
    # 6Ô∏è‚É£ INSERT LOOP
    # ===============================
    for _, row in data.iterrows():
        trade_date = None
        try:
            trade_date = pd.to_datetime(row["Date"]).to_pydatetime()

            cursor.execute(
                insert_sql,
                trade_date,
                symbol,
                float(row["Open"]),
                float(row["High"]),
                float(row["Low"]),
                float(row["Close"]),
                float(row["Adj Close"]),
                int(row["Volume"])
            )

            inserted += 1

        except Exception as e:
            # Duplicate / constraint / datatype errors visible
            print("Insert error:", symbol, trade_date, e)

    conn.commit()
    print(f"‚úÖ Inserted {inserted} rows for {symbol}")

# ===============================
# 7Ô∏è‚É£ CLOSE CONNECTION
# ===============================
cursor.close()
conn.close()

print("\nüéØ ALL DATA INSERTED SUCCESSFULLY")
